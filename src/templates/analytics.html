{% extends "base.html" %}
{% block content %}
<h4 class="mb-3 d-flex align-items-center gap-2">
  <i class="bi bi-speedometer2"></i> Analytics
</h4>

<!-- Summary row -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div class="small text-secondary">
      Range summary — Income:
      <strong>Rs {{ '%.2f'|format(summary.income) }}</strong>
      &nbsp;•&nbsp; Expense:
      <strong>Rs {{ '%.2f'|format(summary.expense) }}</strong>
      &nbsp;•&nbsp; Net:
      <strong class="{{ 'text-success' if summary.net >= 0 else 'text-danger' }}">
        Rs {{ '%.2f'|format(summary.net) }}
      </strong>
    </div>
    <div class="small text-secondary">Tip: use the controls on each chart to change its time window.</div>
  </div>
</div>

<div class="row g-4">
  <!-- By Category (toggle EXP/INC) -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-end gap-2">
        <div class="fw-semibold">By Category (<span id="catTitle">Expenses</span>)</div>
        <div class="d-flex flex-wrap gap-2 align-items-end">
          <div>
            <label class="form-label mb-0 small text-secondary">Month</label>
            <input type="month" id="catMonth" class="form-control form-control-sm" value="{{ default_month }}">
          </div>
          <div class="btn-group" role="group" aria-label="type">
            <input type="radio" class="btn-check" name="catType" id="catTypeExp" value="expense" checked>
            <label class="btn btn-outline-primary btn-sm" for="catTypeExp">Expenses</label>

            <input type="radio" class="btn-check" name="catType" id="catTypeInc" value="income">
            <label class="btn btn-outline-primary btn-sm" for="catTypeInc">Income</label>
          </div>
          <button id="catApply" class="btn btn-primary btn-sm"><i class="bi bi-arrow-repeat me-1"></i>Update</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="catChart" height="260"></canvas>
      </div>
    </div>
  </div>

  <!-- Cashflow (last N days) -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-end gap-2">
        <div class="fw-semibold">Cashflow (Income vs Expense)</div>
        <div class="d-flex align-items-end gap-2">
          <div>
            <label class="form-label mb-0 small text-secondary">Days</label>
            <select id="flowDays" class="form-select form-select-sm">
              <option value="30" selected>30</option>
              <option value="60">60</option>
              <option value="90">90</option>
            </select>
          </div>
          <button id="flowApply" class="btn btn-primary btn-sm"><i class="bi bi-arrow-repeat me-1"></i>Update</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="flowChart" height="260"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script>
(function(){
  const fmtRs = (n)=> `Rs ${Number(n).toLocaleString()}`;
  const palette = ['#4f46e5','#0ea5e9','#22c55e','#f59e0b','#ef4444','#14b8a6','#a78bfa','#f97316','#84cc16','#e11d48'];

  // ---------- Category (toggle) ----------
  const catMonth = document.getElementById('catMonth');
  const catApply = document.getElementById('catApply');
  const catTitle = document.getElementById('catTitle');
  const catTypeRadios = [document.getElementById('catTypeExp'), document.getElementById('catTypeInc')];
  let catChart;

  function renderCat(labels, values, isIncome){
    if (catChart) catChart.destroy();
    catChart = new Chart(document.getElementById('catChart').getContext('2d'), {
      type: 'doughnut',
      data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>palette[i%palette.length]), borderWidth:0 }] },
      options: {
        plugins: {
          legend: { position: 'right' },
          tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${fmtRs(ctx.raw)}` } }
        },
        cutout: '55%'
      }
    });
    catTitle.textContent = isIncome ? 'Income' : 'Expenses';
  }
  function loadCat(){
    const m = catMonth.value;
    const type = catTypeRadios.find(r=>r.checked).value;
    const url = type === 'income'
      ? `/api/income_by_category?month=${encodeURIComponent(m)}`
      : `/api/expense_by_category?month=${encodeURIComponent(m)}`;
    fetch(url).then(r=>r.json()).then(rows=>{
      renderCat(rows.map(r=>r.label), rows.map(r=>+r.value), type==='income');
    }).catch(()=>renderCat([],[], type==='income'));
  }
  catApply.addEventListener('click', loadCat);
  catTypeRadios.forEach(r=>r.addEventListener('change', loadCat));

  // ---------- Cashflow (last N days) ----------
  const flowDays = document.getElementById('flowDays');
  const flowApply = document.getElementById('flowApply');
  let flowChart;

  function renderFlow(labels, inc, exp){
    if (flowChart) flowChart.destroy();
    const ctx = document.getElementById('flowChart').getContext('2d');
    flowChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Income', data: inc, tension:.25, fill:false },
          { label: 'Expense', data: exp, tension:.25, fill:false }
        ]
      },
      options: {
        interaction: { mode:'index', intersect:false },
        plugins: { tooltip: { callbacks: { label:(c)=> `${c.dataset.label}: ${fmtRs(c.raw)}` } } },
        scales: {
          y: { ticks: { callback:(v)=> fmtRs(v) } }
        }
      }
    });
  }
  function loadFlow(){
    const days = flowDays.value || 30;
    fetch(`/api/cashflow_daily?days=${encodeURIComponent(days)}`)
      .then(r=>r.json())
      .then(d=>renderFlow(d.labels, d.income, d.expense))
      .catch(()=>renderFlow([],[],[]));
  }
  flowApply.addEventListener('click', loadFlow);

  // initial paint
  loadCat();
  loadFlow();
})();
</script>
{% endblock %}
