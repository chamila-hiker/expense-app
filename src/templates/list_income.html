{% extends "base.html" %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-cash-coin me-2"></i>All Income</h4>

<form class="row g-2 align-items-end mb-3" method="get" action="{{ url_for('list_income') }}">
  <div class="col-auto">
    <label class="form-label mb-0 small text-secondary">From</label>
    <input type="date" class="form-control" name="from" value="{{ selected_from }}">
  </div>
  <div class="col-auto">
    <label class="form-label mb-0 small text-secondary">To</label>
    <input type="date" class="form-control" name="to" value="{{ selected_to }}">
  </div>
  <div class="col-auto">
    <label class="form-label mb-0 small text-secondary">Category</label>
    <select class="form-select" name="category_id">
      <option value="">All</option>
      {% for c in categories %}
      <option value="{{ c.id }}" {% if selected_cat==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto d-flex gap-2">
    <button class="btn btn-primary"><i class="bi bi-filter me-1"></i>Apply</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('list_income') }}">Reset</a>

    {# Build CSV link explicitly (no **unpack) #}
    <a class="btn btn-success"
       href="{{ url_for('export_income_csv') }}?from={{ selected_from }}&to={{ selected_to }}{% if selected_cat %}&category_id={{ selected_cat }}{% endif %}">
       <i class="bi bi-download me-1"></i>Export CSV
    </a>
  </div>
</form>

<div class="card shadow-sm border-0 table-card-pro">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th><th>Date</th><th>Category</th>
          <th class="text-end">Amount</th><th>Source</th><th>Note</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in incomes %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.tx_date }}</td>
          <td><span class="badge rounded-pill cat-pro">{{ r.category }}</span></td>
          <td class="text-end">Rs {{ "%.2f"|format(r.amount) }}</td>
          <td>{{ r.source or "" }}</td>
          <td>{{ r.note or "" }}</td>
          <td class="text-nowrap d-flex gap-1">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_income', id=r.id) }}"><i class="bi bi-pencil"></i></a>
            <form method="post" action="{{ url_for('delete_income', id=r.id) }}" onsubmit="return confirm('Delete income #{{ r.id }}?');">
              <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-muted">No records.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
